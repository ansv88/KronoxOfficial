@using KronoxFront.Services
@using KronoxFront.ViewModels
@inject CmsService Cms
@inject ILogger<MemberLogosDisplay> Logger
@inject IJSRuntime JS

@if (ShowTitle)
{
    <h4 class="mb-4">Våra medlemmar:</h4>
}

<div class="members-logos @CssClass">
    @if (memberLogos.Any())
    {
        @if (DisplayMode == LogoDisplayMode.Carousel)
        {
            <!-- Desktop Carousel (4 per slide) -->
            <div class="d-none d-md-block">
                <div id="@($"desktopCarousel-{ComponentId}")" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
                    <div class="carousel-inner bg-white shadow rounded-3 p-4">
                        @{
                            var desktopGroups = memberLogos
                                .Select((logo, index) => new { logo, index })
                                .GroupBy(x => x.index / 4)
                                .Select(g => g.Select(x => x.logo).ToList())
                                .ToList();
                            
                            bool isFirstDesktop = true;
                        }
                        @foreach (var group in desktopGroups)
                        {
                            <div class="carousel-item @(isFirstDesktop ? "active" : "")">
                                <div class="row g-3" style="min-height: 100px;">
                                    @foreach (var logo in group)
                                    {
                                        <div class="col-3">
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                @if (!string.IsNullOrEmpty(logo.LinkUrl))
                                                {
                                                    <a href="@logo.LinkUrl" target="_blank" title="Besök @logo.AltText" class="logo-link">
                                                        <img src="@logo.Url" class="img-fluid member-logo" loading="lazy" alt="@logo.AltText" />
                                                    </a>
                                                }
                                                else
                                                {
                                                    <img src="@logo.Url" class="img-fluid member-logo" alt="@logo.AltText" />
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            isFirstDesktop = false;
                        }
                    </div>
                    @if (memberLogos.Count > 4)
                    {
                        <button class="carousel-control-prev" type="button" data-bs-target="#@($"desktopCarousel-{ComponentId}")" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                            <span class="visually-hidden">Föregående</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#@($"desktopCarousel-{ComponentId}")" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                            <span class="visually-hidden">Nästa</span>
                        </button>
                    }
                </div>
            </div>

            <!-- Mobilkarusell (1 per slide) -->
            <div class="d-block d-md-none">
                <div id="@($"mobileCarousel-{ComponentId}")" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
                    <div class="carousel-inner bg-white shadow rounded-3 p-4">
                        @{
                            bool isFirstMobile = true;
                        }
                        @foreach (var logo in memberLogos)
                        {
                            <div class="carousel-item @(isFirstMobile ? "active" : "")">
                                <div class="d-flex justify-content-center align-items-center" style="min-height: 100px;">
                                    @if (!string.IsNullOrEmpty(logo.LinkUrl))
                                    {
                                        <a href="@logo.LinkUrl" target="_blank" title="Besök @logo.AltText" class="logo-link">
                                            <img src="@logo.Url" class="img-fluid member-logo-mobile" alt="@logo.AltText" />
                                        </a>
                                    }
                                    else
                                    {
                                        <img src="@logo.Url" class="img-fluid member-logo-mobile" alt="@logo.AltText" />
                                    }
                                </div>
                            </div>
                            isFirstMobile = false;
                        }
                    </div>
                    @if (memberLogos.Count > 1)
                    {
                        <button class="carousel-control-prev" type="button" data-bs-target="#@($"mobileCarousel-{ComponentId}")" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                            <span class="visually-hidden">Föregående</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#@($"mobileCarousel-{ComponentId}")" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                            <span class="visually-hidden">Nästa</span>
                        </button>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- Griddisplay -->
            <div class="row justify-content-center align-items-center g-4">
                @foreach (var logo in memberLogos.Take(MaxLogos))
                {
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="d-flex justify-content-center align-items-center" style="height: 80px">
                            @if (!string.IsNullOrEmpty(logo.LinkUrl))
                            {
                                <a href="@logo.LinkUrl" target="_blank" title="Besök @logo.AltText">
                                    <img src="@logo.Url" class="img-fluid" 
                                         style="max-height: 60px; max-width: 120px; object-fit: contain;" 
                                         alt="@logo.AltText" />
                                </a>
                            }
                            else
                            {
                                <img src="@logo.Url" class="img-fluid" 
                                     style="max-height: 60px; max-width: 120px; object-fit: contain;" 
                                     alt="@logo.AltText" />
                            }
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <p class="text-muted">@EmptyMessage</p>
    }
</div>

@code {
    [Parameter] public bool ShowTitle { get; set; } = true;
    [Parameter] public string CssClass { get; set; } = "bg-light p-4 rounded";
    [Parameter] public LogoDisplayMode DisplayMode { get; set; } = LogoDisplayMode.Grid;
    [Parameter] public int MaxLogos { get; set; } = 12;
    [Parameter] public string EmptyMessage { get; set; } = "Medlemslogotyper kommer att visas här.";

    private List<MemberLogoViewModel> memberLogos = new();
    private string ComponentId = Guid.NewGuid().ToString("N")[..8];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            memberLogos = await Cms.GetMemberLogosAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fel vid hämtning av medlemslogotyper");
            memberLogos = new List<MemberLogoViewModel>();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && DisplayMode == LogoDisplayMode.Carousel)
        {
            try
            {
                // Ge tid för DOM att renderas
                await Task.Delay(200);

                // Initiera karuseller manuellt för att säkerställa automatisk start
                await JS.InvokeVoidAsync("eval", $@"
                setTimeout(() => {{
                    const desktopCarousel = document.getElementById('desktopCarousel-{ComponentId}');
                    const mobileCarousel = document.getElementById('mobileCarousel-{ComponentId}');

                    if (desktopCarousel) {{
                        const carousel1 = new bootstrap.Carousel(desktopCarousel, {{
                            interval: 4000,
                            wrap: true,
                            pause: 'hover',
                            ride: 'carousel'
                        }});
                        carousel1.cycle();
                        console.log('Desktop-karusell startad för {ComponentId}');
                    }}

                    if (mobileCarousel) {{
                        const carousel2 = new bootstrap.Carousel(mobileCarousel, {{
                            interval: 4000,
                            wrap: true,
                            pause: 'hover',
                            ride: 'carousel'
                        }});
                        carousel2.cycle();
                        console.log('Mobil-karusell startad för {ComponentId}');
                    }}
                }}, 100);
            ");

                Logger.LogInformation("Karusell initialiserad för komponent {ComponentId}", ComponentId);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Fel vid initialisering av karusell för komponent {ComponentId}", ComponentId);
            }
        }
    }

    public enum LogoDisplayMode
    {
        Grid,
        Carousel
    }
}