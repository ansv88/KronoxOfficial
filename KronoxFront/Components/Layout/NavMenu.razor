@using Microsoft.AspNetCore.Components.Authorization
@using System.Diagnostics
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Antiforgery
@using static KronoxFront.Program
@using Microsoft.AspNetCore.WebUtilities
@inject AuthenticationStateProvider AuthStateProvider
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav

<nav class="navbar navbar-expand-lg navbar-custom bg-dark">
    <div class="container-fluid d-flex align-items-center">
        <!-- Logga till vänster -->
        <a class="navbar-brand position-relative" href="/">
            <img src="images/logo.png" alt="KronoX logga" class="logo" />
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <AuthorizeView>
                <NotAuthorized>
                    <ul class="navbar-nav ms-auto gap-3 text-center justify-content-center">
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/omkonsortiet">Om konsortiet</NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/omsystemet">Om systemet</NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/visioner">Visioner & Verksamhetsidé</NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/kontakt">Kontakta oss</NavLink>
                        </li>
                        <li class="nav-item ms-lg-5">
                            <button class="btn btn-link nav-link text-white d-flex align-items-center justify-content-center gap-2"
                                    @onclick="() => showLogin = true">
                                <i class="fa-solid fa-lock fa-xs"></i> Logga in
                            </button>
                        </li>
                    </ul>
                </NotAuthorized>

                <Authorized>
                     <!-- Navigering för inloggade användare -->
                    <ul class="navbar-nav ms-auto gap-3 text-center justify-content-center">
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/medlemsnytt">Medlemsnytt</NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/omkonsortiet">Om konsortiet</NavLink>
                        </li>
                        <!-- Länkar enbart för Admin eller Styrelse -->
                        <AuthorizeView Roles="Admin,Styrelse" Context="roleContext">
                            <Authorized>
                                <li class="nav-item">
                                    <NavLink class="nav-link text-white" href="/for-styrelsen">För styrelsen</NavLink>
                                </li>
                                <li class="nav-item">
                                    <NavLink class="nav-link text-white" href="/for-vnsg">För VNSG</NavLink>
                                </li>
                            </Authorized>
                        </AuthorizeView>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/forvaltning">Förvaltning</NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/dokument">Dokument</NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link text-white" href="/kontakt">Kontakta oss</NavLink>
                        </li>
                        
                        <!-- Admin-länk visas bara för administratörer -->
                        <AuthorizeView Roles="Admin" Context="adminContext">
                            <Authorized>
                                <li class="nav-item">
                                    <NavLink class="nav-link text-white" href="/admin">
                                        <i class="fa-solid fa-gauge fa-xs me-1"></i> Admin
                                    </NavLink>
                                </li>
                            </Authorized>
                        </AuthorizeView>
                        
                        <li class="nav-item ms-lg-5">
                            <button class="btn btn-link nav-link text-white d-flex align-items-center justify-content-center gap-2"
                                    @onclick="() => showLogout = true">
                                <i class="fa-solid fa-unlock fa-xs"></i> Logga ut
                            </button>
                        </li>
                    </ul>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
</nav>

<!-- Inloggningsmodal -->
@if (showLogin)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Logga in</h5>
                    <button type="button" class="btn-close" @onclick="() => showLogin = false"></button>
                </div>

                <form method="post" action="/auth/login">
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(loginErrorMessage))
                        {
                            <div class="alert alert-danger mb-3">
                                @loginErrorMessage
                            </div>
                        }
                        <div class="mb-3">
                            <label class="form-label">Användarnamn</label>
                            <input class="form-control" name="username" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lösenord</label>
                            <input type="password" class="form-control" name="password" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary"
                                @onclick="() => showLogin = false">
                            Avbryt
                        </button>
                        <button type="submit" class="btn btn-primary">Logga in</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Utloggningsmodal -->
@if (showLogout)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bekräfta utloggning</h5>
                    <button type="button" class="btn-close" @onclick="() => showLogout = false"></button>
                </div>

                <div class="modal-body">
                    <AuthorizeView Context="logoutContext">
                        <Authorized>
                            <p class="text-center">
                                Du är inloggad som <strong>@logoutContext.User.Identity!.Name</strong>. <br /> <br />
                                Vill du logga ut?
                            </p>
                        </Authorized>
                        <NotAuthorized>
                            <p>Du är inte inloggad.</p>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary"
                            @onclick="() => showLogout = false">
                        Avbryt
                    </button>

                    <form method="post" action="/auth/logout" @onsubmit:preventDefault="false" class="m-0">
                        <button type="submit" class="btn btn-primary">Logga ut</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool showLogin;
    private bool showLogout;
    private string? loginErrorMessage;

    protected override void OnInitialized()
    {
        // Kontrollera URL-parametrar vid initialisering för att se om det finns felmeddelanden
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("loginerror", out var errorValues))
        {
            showLogin = true;
            loginErrorMessage = GetErrorMessage(errorValues.ToString());
        }
    }

    private void OpenLoginModal()
    {
        loginErrorMessage = null;
        showLogin = true;
    }

    private string GetErrorMessage(string errorCode)
    {
        return errorCode switch
        {
            "credentials" => "Felaktigt användarnamn eller lösenord.",
            "newuserlogin" => "Du kan inte logga in ännu eftersom ditt konto väntar på godkännande.",
            "unauthorized" => "Du har inte behörighet att logga in.",
            _ => "Ett fel uppstod vid inloggning. Försök igen."
        };
    }
}
