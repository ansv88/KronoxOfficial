@page "/medlemsnytt"
@using KronoxFront.Components.Admin
@using KronoxFront.Components.Shared.Security
@using KronoxFront.ViewModels
@using KronoxFront.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using KronoxFront.Components.Shared
@using KronoxFront.Components.Shared.Layout
@using KronoxFront.Components.Shared.Content
@using KronoxFront.Components.Shared.UI
@using KronoxFront.Components.Shared.Forms
@attribute [Authorize]
@inject CmsService Cms
@inject AuthenticationStateProvider AuthState
@inject IJSRuntime JS
@inject ILogger<Medlemsnytt> Logger

<!-- Garantierad avstängning: Redirecta till 404 om NavigationConfig markerar sidan som inaktiv -->
<RequirePageEnabled PageKey="medlemsnytt" FailClosed="true" />

<HeadContent>
    <meta name="description" content="Senaste nyheterna och uppdateringarna för KronoX-konsortiet. Information för medlemmar." />
</HeadContent>

<PageTitle>@($"{(string.IsNullOrWhiteSpace(pageContent?.Title) ? "Medlemsnytt" : pageContent!.Title)} - KronoX")</PageTitle>
<h1 class="visually-hidden">@((string.IsNullOrWhiteSpace(pageContent?.Title) ? "Medlemsnytt" : pageContent!.Title))</h1>

@if (loading)
{
    <div class="text-center mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Laddar...</span>
        </div>
    </div>
}
else
{
    @* Dynamisk rendering baserat på sektionskonfiguration *@
    @foreach (var section in sectionConfigurations.Where(s => s.IsEnabled).OrderBy(s => s.SortOrder))
    {
        @switch (section.Type)
        {
            case SectionType.Banner:
                <PageHeroBanner ImageUrl="@GetHeroBannerUrl()" AltText="@GetHeroBannerAlt()"
                                IsAdmin="@isAdmin" PageKey="medlemsnytt" />
                break;

            case SectionType.Intro:
                @if (!string.IsNullOrEmpty(introSection.BreadcrumbTitle))
                {
                    <PageBreadcrumb Title="@introSection.BreadcrumbTitle" />
                }
                <IntroSection Model="@introSection" OnImageClick="@ShowImage" />
                break;

            case SectionType.NavigationButtons:
                @if (introSection.ShowNavigationButtons && introSection.NavigationButtons.Any())
                {
                    <NavigationButtons Buttons="@introSection.NavigationButtons" />
                }
                break;

            case SectionType.NewsSection:
                <div class="wrapper-div py-3">
                    <section class="container mt-2 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                        <div style="max-width:800px; margin: 0 auto;">
                            <NewsSection PageKey="medlemsnytt" 
                                         Title="Medlemsnytt"
                                         MaxItems="10"
                                         ShowFilters="true"
                                         ShowPagination="true"
                                         ShowArchiveToggle="true"
                                         ShowAllNewsLink="false" />
                        </div>
                    </section>
                </div>
                break;

            case SectionType.FeatureSections:
                @if (featureSections.Any())
                {
                    <div class="wrapper-div py-3">
                        <section class="container mt-2 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                            <div style="max-width:800px; margin: 0 auto;">
                                <FeatureSections IsAdmin="@isAdmin" 
                                                 PageKey="medlemsnytt" OnImageClick="@ShowImage" />
                            </div>
                        </section>
                    </div>
                }
                break;

            case SectionType.FaqSections:
                @if (faqSections.Any())
                {
                    <div class="wrapper-div py-3">
                        <section class="container mt-2 my-5 bg-white rounded-3" style="max-width:1000px">
                            <div style="max-width:800px; margin: 0 auto;">
                                <FaqAccordion FaqSections="@faqSections" />
                            </div>
                        </section>
                    </div>
                }
                break;

            case SectionType.MemberLogos:
                <div class="wrapper-div py-3">
                    <MemberLogosSection Title="Våra medlemmar:" IsDarkBackground="true" />
                </div>
                break;

            case SectionType.DocumentSection:
                <div class="wrapper-div py-3">
                    <section class="container mt-2 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                        <div style="max-width:800px; margin: 0 auto;">
                            <DocumentSection PageKey="medlemsnytt" 
                                             Title="Medlemsdokument"
                                             ShowFilters="true"
                                             ShowCategoryHeaders="true"
                                             ShowAllDocumentsLink="true"
                                             MaxDocumentsPerCategory="5" />
                        </div>
                    </section>
                </div>
                break;

            case SectionType.ActionPlanTable:
                <div class="wrapper-div py-3">
                    <section class="container mt-2 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                        <ActionPlanSection ActionPlan="@actionPlan" Title="Handlingsplan" />
                    </section>
                </div>
                break;

            case SectionType.DevelopmentSuggestionForm:
                <div class="wrapper-div py-3">
                    <section class="container mt-2 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                        <div style="max-width:800px; margin: 0 auto;">
                            <DevelopmentSuggestionForm />
                        </div>
                    </section>
                </div>
                break;
        }
    }

    <ScrollTopButton />
    <ImageModal ImageUrl="@activeImage" OnClose="@CloseModal" />
}

@code {
    private PageContentViewModel pageContent = new();
    private IntroSectionViewModel introSection = new();
    private List<FeatureSectionViewModel> featureSections = new();
    private List<FaqSectionViewModel> faqSections = new();
    private List<SectionConfigItem> sectionConfigurations = new();
    private ActionPlanTableViewModel actionPlan = new();
    
    private bool loading = true;
    private bool isAdmin = false;
    private string? activeImage;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        isAdmin = authState.User.IsInRole("Admin");
        loading = true;

        try
        {
            await LoadPageContent();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fel vid laddning av medlemsnytt");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadPageContent()
    {
        try
        {
            // Ladda grundläggande sidinnehåll för fallback-titel
            pageContent = await Cms.GetPageContentAsync("medlemsnytt")
                          ?? new PageContentViewModel
                          {
                              PageKey = "medlemsnytt",
                              Title = "Medlemsnytt",
                              HtmlContent = "",
                              LastModified = DateTime.Now,
                              Images = new List<PageImageViewModel>()
                          };

            // Ladda intro-sektion
            introSection = await Cms.GetIntroSectionAsync("medlemsnytt");
            
            // Ladda feature- och FAQ-sektioner
            featureSections = await Cms.GetFeatureSectionsAsync("medlemsnytt");
            faqSections = await Cms.GetFaqSectionsAsync("medlemsnytt");
            
            // Sätt standardvärden om inget innehåll finns i intro
            if (string.IsNullOrEmpty(introSection.Title))
            {
                introSection.Title = "För medlemmar";
                introSection.Content = @"<p>Här hittar du de senaste uppdateringarna och nyheterna om KronoX och konsortiet.</p>
                                        <p>Vill du läsa mer om Konsortiets medlemmar och hur de arbetar med KronoX hittar du det under <strong>Om konsortiet</strong>.</p>
                                        <p>Letar du efter kontaktuppgifter till medlemmarna finns det under <strong>Om konsortiet</strong>.</p>
                                        <p>Söker du information om handlingar/användande/instruktioner för schemasystemet, hittar du det i <strong>Manualen</strong>.</p>";
                introSection.BreadcrumbTitle = "MEDLEMSNYTT";
            }

            // Ladda sektionskonfiguration
            sectionConfigurations = await Cms.GetPageSectionConfigAsync("medlemsnytt");

            // Om ingen konfiguration finns, skapa standardkonfiguration
            if (!sectionConfigurations.Any())
            {
                Logger.LogWarning("Ingen sektionskonfiguration hittades för medlemsnytt, skapar fallback");
                sectionConfigurations = new List<SectionConfigItem>
                {
                    new() { Type = SectionType.Banner, SortOrder = 0, IsEnabled = true },
                    new() { Type = SectionType.Intro, SortOrder = 1, IsEnabled = true },
                    new() { Type = SectionType.NavigationButtons, SortOrder = 2, IsEnabled = false },
                    new() { Type = SectionType.NewsSection, SortOrder = 3, IsEnabled = true },
                    new() { Type = SectionType.FeatureSections, SortOrder = 4, IsEnabled = false },
                    new() { Type = SectionType.FaqSections, SortOrder = 5, IsEnabled = false },
                    new() { Type = SectionType.MemberLogos, SortOrder = 6, IsEnabled = true }
                };
            }

            // Ladda handlingsplan om aktiverad
            if (sectionConfigurations.Any(s => s.Type == SectionType.ActionPlanTable && s.IsEnabled))
            {
                try
                {
                    actionPlan = await Cms.GetActionPlanAsync("medlemsnytt");
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Kunde inte hämta handlingsplan för medlemsnytt - fortsätter utan");
                    actionPlan = new ActionPlanTableViewModel();
                }
            }

        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fel vid laddning av sidinnehåll för medlemsnytt");
            
            // Fallback-innehåll
            pageContent = new PageContentViewModel
            {
                PageKey = "medlemsnytt",
                Title = "Medlemsnytt",
                HtmlContent = "",
                LastModified = DateTime.Now,
                Images = new List<PageImageViewModel>()
            };

            introSection = new IntroSectionViewModel
            {
                Title = "För medlemmar",
                Content = "<p>Här hittar du senaste nyheterna för medlemmar.</p>",
                BreadcrumbTitle = "MEDLEMSNYTT"
            };

            // Skapa minimal konfiguration
            sectionConfigurations = new List<SectionConfigItem>
            {
                new() { Type = SectionType.Banner, SortOrder = 0, IsEnabled = true },
                new() { Type = SectionType.Intro, SortOrder = 1, IsEnabled = true },
                new() { Type = SectionType.NewsSection, SortOrder = 2, IsEnabled = true }
            };
        }
    }

    private string GetHeroBannerUrl()
    {
        var heroBanner = pageContent.Images?.FirstOrDefault(i => i.AltText?.StartsWith("hero:") == true);
        return heroBanner?.Url ?? "";
    }

    private string GetHeroBannerAlt()
    {
        var heroBanner = pageContent.Images?.FirstOrDefault(i => i.AltText?.StartsWith("hero:") == true);
        return heroBanner?.AltText?.Substring(5) ?? "";
    }

    private void ShowImage(string imageUrl)
    {
        activeImage = imageUrl;
    }

    private void CloseModal() => activeImage = null;
}