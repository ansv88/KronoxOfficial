@page "/admin/dashboard"
@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@attribute [Authorize]
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout
@inject NavigationManager Nav
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<AdminDashboard> Logger

<HeadContent>
    <meta name="description" content="Administratörspanel för KronoX. Hantera användare, innehåll och systeminställningar på ett ställe." />
</HeadContent>

<PageTitle>KronoX - Admin Dashboard</PageTitle>

<h1 class="mb-4 text-center">Admin Dashboard</h1>

<div class="row g-3 mb-4">
    <!-- Väntande -->
    <div class="col-sm-6 col-xl-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex">
                <div class="me-3">
                    <i class="fa-solid fa-inbox fa-2x"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <h3 class="h6 mb-1">Att hantera</h3>
                        @if (PendingApprovals > 0)
                        {
                            <span class="badge bg-warning text-dark">@PendingApprovals</span>
                        }
                    </div>
                    <div class="display-6 fw-semibold lh-1">@PendingApprovals</div>
                    <div class="small text-muted mt-1">
                        @newUserCount nya användare · @newSuggestionsCount nya förslag
                    </div>
                    <div class="mt-2 d-flex gap-2">
                        <a href="/admin/users" class="btn btn-sm btn-outline-primary">Användare</a>
                        <a href="/admin/suggestions" class="btn btn-sm btn-outline-primary">Förslag</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nyhetsstatus -->
    <div class="col-sm-6 col-xl-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex">
                <div class="me-3">
                    <i class="fa-solid fa-newspaper fa-2x"></i>
                </div>
                <div class="flex-grow-1">
                    <h3 class="h6 mb-1">Nyheter (publicerade)</h3>
                    <div class="display-6 fw-semibold lh-1">@PublishedNewsCount</div>
                    <div class="small text-muted mt-1">Arkiverade: @archivedNewsCount</div>
                    <div class="mt-2">
                        <a href="/admin/news" class="btn btn-sm btn-outline-primary">Hantera nyheter</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dokument -->
    <div class="col-sm-6 col-xl-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex">
                <div class="me-3">
                    <i class="fa-solid fa-file-alt fa-2x"></i>
                </div>
                <div class="flex-grow-1">
                    <h3 class="h6 mb-1">Dokument</h3>
                    <div class="display-6 fw-semibold lh-1">@documentsCount</div>
                    <div class="small text-muted mt-1">Kategorier: @mainCategoryCount/@subCategoryCount</div>
                    <div class="mt-2">
                        <a href="/admin/documents/manage" class="btn btn-sm btn-outline-primary">Hantera dokument</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Användare -->
    <div class="col-sm-6 col-xl-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex">
                <div class="me-3">
                    <i class="fa-solid fa-users fa-2x"></i>
                </div>
                <div class="flex-grow-1">
                    <h3 class="h6 mb-1">Användare (totalt)</h3>
                    <div class="display-6 fw-semibold lh-1">@userCount</div>
                    <div class="small text-muted mt-1">Nya ansökningar: @newUserCount</div>
                    <div class="mt-2">
                        <a href="/admin/users" class="btn btn-sm btn-outline-primary">Hantera användare</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Publika sidor -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-globe me-2"></i>Publika sidor</h2>
            </div>
            <div class="card-body">
                <p class="card-text">
                    Hantera innehåll på de offentliga sidorna som är tillgängliga för alla besökare.
                </p>
                <div class="alert alert-info mb-3">
                    <i class="fa-solid fa-shield-alt me-1"></i>Dessa sidor kan visa anpassat innehåll beroende på om användaren är inloggad och vilken roll de har.
                </div>

                <div class="list-group mb-3">
                    <a href="/admin/home" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Startsida</span>
                            <small class="d-block text-muted">Kan visa anpassat innehåll för inloggade användare</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/omkonsortiet" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Om konsortiet</span>
                            <small class="d-block text-muted">Kan visa anpassat innehåll för inloggade användare</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/omsystemet" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Om systemet</span>
                            <small class="d-block text-muted">Kan visa anpassat innehåll för inloggade användare</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/visioner" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Visioner & Verksamhetsidé</span>
                            <small class="d-block text-muted">Kan visa anpassat innehåll för inloggade användare</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/kontaktaoss" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Kontakta oss</span>
                            <small class="d-block text-muted">Kan visa anpassat innehåll för inloggade användare</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Interna sidor -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-lock me-2"></i>Interna sidor</h2>
            </div>
            <div class="card-body">
                <p class="card-text">
                    Hantera innehåll på medlemssidor som endast är tillgängliga efter inloggning.
                </p>
                <div class="list-group mb-3">
                    <a href="/admin/medlemsnytt" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Medlemsnytt</span>
                            <small class="d-block text-muted">Kräver inloggning - innehåller nyhetssektion</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/forstyrelsen" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">För styrelsen</span>
                            <small class="d-block text-muted">Kräver inloggning och rollen "Admin" eller "Styrelse"</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/forvnsg" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">För VNSG</span>
                            <small class="d-block text-muted">Kräver inloggning och rollen "Admin" eller "Styrelse"</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/forvaltning" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Förvaltning</span>
                            <small class="d-block text-muted">Kräver inloggning - innehåller handlingsplan och utvecklingsförslag</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/dokument" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Dokument</span>
                            <small class="d-block text-muted">Kräver inloggning</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidhantering + Användarhantering -->
<div class="row">
    <!-- Hantera sidor & Navigation -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-file-plus me-2"></i>Sidhantering</h2>
            </div>
            <div class="card-body">
                <p class="card-text">Skapa och hantera anpassade sidor samt konfigurera navigationsmeny.</p>
                <div class="list-group mb-3">
                    <a href="/admin/pages" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Hantera sidor</span>
                            <small class="d-block text-muted">Skapa, redigera och ta bort anpassade sidor</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                    <a href="/admin/navigation" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">Hantera navigation</span>
                            <small class="d-block text-muted">Konfigurera navigationsmenyer och sorteringsordning</small>
                        </div>
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
                <div class="alert alert-info">
                    <i class="fa-solid fa-lightbulb me-1"></i>
                    <strong>Tips:</strong> När du skapar nya sidor läggs de automatiskt till i navigationsmenyn.
                </div>
            </div>
        </div>
    </div>

    <!-- Användarhantering -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0"><i class="fa-solid fa-users me-2"></i>Användarhantering</h2>
                @if (newUserCount > 0)
                {
                    <span class="badge bg-danger">@newUserCount</span>
                }
            </div>
            <div class="card-body">
                <p class="card-text">Hantera användarkonton, godkänn nya användare och ändra behörigheter.</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            Aktiva användare
                            <small class="d-block text-muted">Godkända användare med olika roller</small>
                        </span>
                        <span class="badge bg-primary rounded-pill">@userCount</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            Nya ansökningar
                            <small class="d-block text-muted">Väntar på godkännande</small>
                        </span>
                        <span class="badge bg-warning text-dark rounded-pill">@newUserCount</span>
                    </li>
                </ul>
                <a href="/admin/users" class="btn btn-primary">
                    <i class="fa-solid fa-user-gear me-2"></i>Hantera användare
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Nyhetshantering + Dokumenthantering -->
<div class="row">
    <!-- Nyhetshantering -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-newspaper me-2"></i>Nyhetshantering</h2>
            </div>
            <div class="card-body">
                <p class="card-text">Skapa och hantera nyheter och meddelanden som visas för medlemmar.</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            Publicerade nyheter
                            <small class="d-block text-muted">Synliga för medlemmar</small>
                        </span>
                        <span class="badge bg-success rounded-pill">@(newsCount - archivedNewsCount)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            Arkiverade nyheter
                            <small class="d-block text-muted">Dolda från medlemmar</small>
                        </span>
                        <span class="badge bg-secondary rounded-pill">@archivedNewsCount</span>
                    </li>
                </ul>
                <div class="d-flex gap-2">
                    <a href="/admin/news" class="btn btn-primary">
                        <i class="fa-solid fa-pen-to-square me-2"></i>Hantera nyheter
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dokumenthantering -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-file-alt me-2"></i>Dokumenthantering</h2>
            </div>
            <div class="card-body">
                <p class="card-text">Ladda upp och organisera dokument i olika kategorier.</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Totalt antal dokument</span>
                        <span class="badge bg-primary rounded-pill">@documentsCount</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Huvudkategorier</span>
                        <span class="badge bg-info rounded-pill">@mainCategoryCount</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Underkategorier</span>
                        <span class="badge bg-secondary rounded-pill">@subCategoryCount</span>
                    </li>
                </ul>
                <a href="/admin/documents/manage" class="btn btn-primary">
                    <i class="fa-solid fa-folder-open me-2"></i>Hantera dokument
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Handlingsplan + Utvecklingsförslag -->
<div class="row">
    <!-- Handlingsplan -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-clipboard-list me-2"></i>Handlingsplan</h2>
            </div>
            <div class="card-body">
                <p class="card-text">Administrera handlingsplanens aktiviteter och leveranser.</p>
                <a href="/admin/actionplan" class="btn btn-primary">
                    <i class="fa-solid fa-list-check me-2"></i>Hantera handlingsplan
                </a>
            </div>
        </div>
    </div>

    <!-- Utvecklingsförslag -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0"><i class="fa-solid fa-lightbulb me-2"></i>Utvecklingsförslag</h2>
                @if (newSuggestionsCount > 0)
                {
                    <span class="badge bg-warning text-dark">@newSuggestionsCount</span>
                }
            </div>
            <div class="card-body">
                <p class="card-text">Hantera utvecklingsförslag som skickats in av användare.</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            Totalt antal förslag
                            <small class="d-block text-muted">Alla förslag som skickats in</small>
                        </span>
                        <span class="badge bg-primary rounded-pill">@totalSuggestionsCount</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            Nya förslag
                            <small class="d-block text-muted">Väntar på hantering</small>
                        </span>
                        <span class="badge bg-warning text-dark rounded-pill">@newSuggestionsCount</span>
                    </li>
                </ul>
                <a href="/admin/suggestions" class="btn btn-primary">
                    <i class="fa-solid fa-list-check me-2"></i>Hantera förslag
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Medlemslogotyper -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h2 class="h5 mb-0"><i class="fa-solid fa-university me-2"></i>Medlemslogotyper</h2>
            </div>
            <div class="card-body">
                <p class="card-text">Hantera logotyper för konsortiets medlemmar som visas på webbplatsen.</p>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Registrerade logotyper</span>
                        <span class="badge bg-info rounded-pill">@memberLogosCount</span>
                    </li>
                </ul>
                <a href="/admin/memberlogos" class="btn btn-primary">
                    <i class="fa-solid fa-images me-2"></i>Hantera logotyper
                </a>
            </div>
        </div>
    </div>
</div>

@code {
    // Statistikräknare
    private int userCount = 0;
    private int newUserCount = 0;
    private int documentsCount = 0;
    private int mainCategoryCount = 0;
    private int subCategoryCount = 0;
    private int newsCount = 0;
    private int archivedNewsCount = 0;
    private int memberLogosCount = 0;
    private int newSuggestionsCount = 0;
    private int totalSuggestionsCount = 0;

    private int PublishedNewsCount => Math.Max(0, newsCount - archivedNewsCount);
    private int PendingApprovals => Math.Max(0, newUserCount + newSuggestionsCount);

    // Laddar statistik vid initiering
    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    // Hämtar statistik från API och hanterar fel/loggning.
    private async Task LoadStatistics()
    {
        var http = HttpClientFactory.CreateClient("KronoxAPI");

        // Hämta användarstatistik
        try
        {
            var usersResponse = await http.GetFromJsonAsync<List<object>>("api/admin/users");
            if (usersResponse != null)
            {
                userCount = usersResponse.Count;
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Kunde inte hämta användarstatistik från API.");
            userCount = 0;
        }

        // Hämta nya användarregistreringar
        try
        {
            var newUsersResponse = await http.GetFromJsonAsync<List<object>>("api/admin/registration-requests");
            if (newUsersResponse != null)
            {
                newUserCount = newUsersResponse.Count;
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Kunde inte hämta nya användarregistreringar från API.");
            newUserCount = 0;
        }

        // Hämta dokumentdata
        try
        {
            var documentsResponse = await http.GetFromJsonAsync<List<object>>("api/documents");
            if (documentsResponse != null)
            {
                documentsCount = documentsResponse.Count;
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Kunde inte hämta dokumentdata från API.");
            documentsCount = 0;
        }

        // Hämta kategoridata
        try
        {
            var mainCategoriesResponse = await http.GetFromJsonAsync<List<object>>("api/category/main");
            if (mainCategoriesResponse != null)
            {
                mainCategoryCount = mainCategoriesResponse.Count;
            }

            var subCategoriesResponse = await http.GetFromJsonAsync<List<object>>("api/category/sub");
            if (subCategoriesResponse != null)
            {
                subCategoryCount = subCategoriesResponse.Count;
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Kunde inte hämta kategoridata från API.");
            mainCategoryCount = 0;
            subCategoryCount = 0;
        }

        // Hämta nyhetsdata
        try
        {
            var allNewsResponse = await http.GetFromJsonAsync<JsonElement[]>("api/news/all");
            if (allNewsResponse != null)
            {
                newsCount = allNewsResponse.Length;
                // Räkna arkiverade nyheter
                archivedNewsCount = allNewsResponse.Count(n => 
                {
                    try 
                    {
                        return n.GetProperty("isArchived").GetBoolean();
                    }
                    catch 
                    {
                        return false;
                    }
                });
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Kunde inte hämta nyhetsdata från API.");
            newsCount = 0;
            archivedNewsCount = 0;
        }

        // Hämta medlemslogotyper
        try
        {
            var logosResponse = await http.GetFromJsonAsync<List<object>>("api/cms/logos");
            if (logosResponse != null)
            {
                memberLogosCount = logosResponse.Count;
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Kunde inte hämta medlemslogotyper från API.");
            memberLogosCount = 0;
        }

        // Hämta utvecklingsförslag
        try
        {
            // Hämta alla förslag
            var allSuggestionsResponse = await http.GetFromJsonAsync<List<object>>("api/developmentsuggestion");
            if (allSuggestionsResponse != null)
            {
                totalSuggestionsCount = allSuggestionsResponse.Count;
            }

            // Hämta nya förslag (ej behandlade)
            var newSuggestionsResponse = await http.GetFromJsonAsync<List<object>>("api/developmentsuggestion?includeProcessed=false");
            if (newSuggestionsResponse != null)
            {
                newSuggestionsCount = newSuggestionsResponse.Count;
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Fel vid hämtning av utvecklingsförslag från API.");
            newSuggestionsCount = 0;
            totalSuggestionsCount = 0;
        }
    }
}