@page "/omsystemet"
@using System.Text.Json
@using KronoxFront.DTOs
@using KronoxFront.Services
@using KronoxFront.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using KronoxFront.Components.Shared
@inject CmsService Cms
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthState
@inject ILogger<Omsystemet> Logger

<HeadContent>
    <meta name="description" content="Utforska KronoX-systemets funktioner, teknik och fördelar för schemaläggning och resursbokning inom högre utbildning." />
</HeadContent>

<PageTitle>KronoX - Om systemet</PageTitle>
<h1 class="visually-hidden">Om systemet</h1>

@if (loading)
{
    <div class="text-center mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Laddar...</span>
        </div>
    </div>
}
else
{
    @* ---------- Hero/banner ------------------------------------------------ *@
    <section class="hero-banner position-relative">
        @{
            var heroBanner = pageContent.Images?.FirstOrDefault(i => i.AltText.StartsWith("hero:"));
            var heroBannerUrl = heroBanner != null ? heroBanner.Url : "images/hero/system_hero.jpg";
            var heroBannerAlt = heroBanner != null ? heroBanner.AltText.Substring(5) : "KronoX systemet";
        }
        <img src="@heroBannerUrl" class="img-fluid w-100" alt="@heroBannerAlt" />
        @if (isAdmin)
        {
            <div class="position-absolute top-0 end-0 m-3">
                <a href="/admin/omsystemet" class="btn btn-dark btn-sm opacity-75">
                    <i class="fa-solid fa-edit me-1"></i> Redigera sida
                </a>
            </div>
        }
    </section>

    @* ---------- Breadcrumb-stil huvudrubrik -------------------------------- *@
    <section class="container mt-4" style="max-width:1000px; margin: 0 auto;">
        <div class="text-start mb-4">
            <h2 class="h5 text-muted mb-0">VARFÖR VÄLJA KRONOX?</h2>
        </div>
    </section>

    @* ---------- Intro ------------------------------------------------------- *@
    <section class="container mt-3" style="max-width:1000px; margin: 0 auto;">
        <div class="row align-items-center">
            @if (introSection.HasImage && !string.IsNullOrEmpty(introSection.ImageUrl))
            {
                <div class="col-md-4 mb-4 mb-md-0">
                    <img src="@introSection.ImageUrl" class="img-fluid rounded-3 shadow"
                         alt="@(string.IsNullOrEmpty(introSection.ImageAltText) ? introSection.Title : introSection.ImageAltText)"
                         style="cursor:pointer"
                         @onclick="() => ShowImage(introSection.ImageUrl)" />
                </div>
                <div class="col-md-8 text-center">
                    @if (!string.IsNullOrWhiteSpace(introSection.Title))
                    {
                        <h2 class="mb-4 fw-bold">@introSection.Title</h2>
                    }
                    <div class="intro-content">
                        @((MarkupString)introSection.Content)
                    </div>
                </div>
            }
            else
            {
                <div class="col-12 text-center">
                    @if (!string.IsNullOrWhiteSpace(introSection.Title))
                    {
                        <h2 class="mb-4 fw-bold">@introSection.Title</h2>
                    }
                    <div class="intro-content">
                        @((MarkupString)introSection.Content)
                    </div>
                </div>
            }
        </div>
    </section>

    @* ---------- Navigeringsknappar ------------------------------------------------- *@
    <section class="container mt-4" style="max-width:1000px; margin: 0 auto;">
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-3 my-4">
            <a class="btn btn-dark px-4 py-3 btn-arrow" href="/omkonsortiet">
                Om konsortiet <i class="fa-solid fa-arrow-right ms-2"></i>
            </a>
            <a class="btn btn-dark px-4 py-3 btn-arrow" href="/anvandartraffar">
                Användarträffar <i class="fa-solid fa-arrow-right ms-2"></i>
            </a>
            <a class="btn btn-dark px-4 py-3 btn-arrow" href="/kontaktaoss">
                Kontakta oss <i class="fa-solid fa-arrow-right ms-2"></i>
            </a>
        </div>
    </section>

    <div class="wrapper-div py-3">
        @* ---------- Feature Sections ---------------------------------------- *@
        @if (featureSections.Count > 0)
        {
            <section class="container mt-4 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                <div style="max-width:800px; margin: 0 auto;">
                    @foreach (var (featureItem, index) in featureSections.Select((s, i) => (s, i)))
                    {
                        <div class="feature-section row align-items-center mb-5">
                            @if (featureItem.HasImage)
                            {
                                <div class="col-md-4 mb-3 mb-md-0">
                                    @if (!string.IsNullOrEmpty(featureItem.ImageUrl))
                                    {
                                        <img src="@featureItem.ImageUrl"
                                        class="img-thumbnail feature-thumb w-100"
                                        style="cursor:pointer"
                                        alt="@(!string.IsNullOrEmpty(featureItem.ImageAltText) ? featureItem.ImageAltText : $"Bild för {featureItem.Title}")"
                                        @onclick="() => ShowImage(featureItem.ImageUrl)" />
                                    }
                                    else
                                    {
                                        <div class="bg-light p-4 text-center rounded">
                                            <i class="fa-solid fa-image text-muted fa-3x"></i>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-8">
                                    @if (!string.IsNullOrWhiteSpace(featureItem.Title))
                                    {
                                        <h3 class="mb-4 fw-bold">@featureItem.Title</h3>
                                    }
                                    <div>@((MarkupString)featureItem.Content)</div>
                                </div>
                            }
                            else
                            {
                                <div class="col-12 text-center">
                                    @if (!string.IsNullOrWhiteSpace(featureItem.Title))
                                    {
                                        <h3 class="mb-4 fw-bold">@featureItem.Title</h3>
                                    }
                                    <div>@((MarkupString)featureItem.Content)</div>
                                </div>
                            }
                        </div>

                        @if (index < featureSections.Count - 1)
                        {
                            <div class="divider"></div>
                        }
                    }
                </div>
            </section>
        }

        @* ---------- FAQ Accordion ---------------------------------------- *@
        <FaqAccordion FaqSections="faqSections" />

        @* ---------- Bildkarusell medlemmar ----------- *@
        <section class="py-5 text-center mb-2" style="max-width:1000px; margin: 0 auto;">
            <h3 class="text-start mb-3 fs-5" style="color: rgba(255, 255, 255, 0.85);">Våra medlemmar:</h3>
            <MemberLogosDisplay DisplayMode="MemberLogosDisplay.LogoDisplayMode.Carousel" ShowTitle="false" />
        </section>
    </div>

    @* ---------- Bilder Modal ------------------------------------------------ *@
    @if (!string.IsNullOrEmpty(activeImage))
    {
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,.5);"
             role="dialog" aria-modal="true" aria-label="Förhandsgranskning av bild">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content border-0 bg-transparent">
                    <button type="button" class="btn-close btn-close-white ms-auto me-n4 mt-n4" @onclick="CloseModal"></button>
                    <img src="@activeImage" class="img-fluid rounded-3" />
                </div>
            </div>
        </div>
    }
}

@code {
    private PageContentViewModel pageContent = new();
    private bool loading = true;
    private bool isAdmin = false;
    private string? activeImage;
    private IntroSectionViewModel introSection = new();
    private List<FeatureSectionViewModel> featureSections = new();
    private List<FaqSectionViewModel> faqSections = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        isAdmin = authState.User.IsInRole("Admin");
        loading = true;

        try
        {
            // Hämta sidinnehåll
            pageContent = await Cms.GetPageContentAsync("omsystemet") ?? new PageContentViewModel
            {
                PageKey = "omsystemet",
                Title = "Om systemet",
                HtmlContent = "",
                LastModified = DateTime.Now,
                Images = new List<PageImageViewModel>()
            };

            // Hämta intro-sektion
            introSection = await Cms.GetIntroSectionAsync("omsystemet");

            // Hämta feature-sektioner
            featureSections = await Cms.GetFeatureSectionsAsync("omsystemet");

            // Hämta FAQ-sektioner
            faqSections = await Cms.GetFaqSectionsAsync("omsystemet");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fel vid inläsning av Om systemet-sidan: {Message}", ex.Message);

            // Minimal fallback
            introSection = new IntroSectionViewModel
            {
                Title = "Något gick fel",
                Content = "<p>Det uppstod ett fel vid hämtning av innehållet.</p>"
            };
            featureSections = new List<FeatureSectionViewModel>();
            faqSections = new List<FaqSectionViewModel>();
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowImage(string imageUrl)
    {
        activeImage = imageUrl;
    }

    private void CloseModal() => activeImage = null;
}
