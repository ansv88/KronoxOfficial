@page "/omsystemet"
@using System.Text.Json
@using KronoxFront.DTOs
@using KronoxFront.Services
@using KronoxFront.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using KronoxFront.Components.Shared
@inject CmsService Cms
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthState
@inject ILogger<Omsystemet> Logger

<HeadContent>
    <meta name="description" content="Utforska KronoX-systemets funktioner, teknik och fördelar för schemaläggning och resursbokning inom högre utbildning." />
</HeadContent>

<PageTitle>KronoX - Om systemet</PageTitle>
<h1 class="visually-hidden">Om systemet</h1>

@if (loading)
{
    <div class="text-center mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Laddar...</span>
        </div>
    </div>
}
else
{
    var heroBanner = pageContent.Images?.FirstOrDefault(i => i.AltText.StartsWith("hero:"));
    var heroBannerUrl = heroBanner != null ? heroBanner.Url : "images/hero/system_hero.jpg";
    var heroBannerAlt = heroBanner != null ? heroBanner.AltText.Substring(5) : "KronoX systemet";

    <PageHeroBanner ImageUrl="@heroBannerUrl" AltText="@heroBannerAlt" 
                    IsAdmin="@isAdmin" PageKey="omsystemet" />

    @if (!string.IsNullOrEmpty(introSection.BreadcrumbTitle))
    {
        <PageBreadcrumb Title="@introSection.BreadcrumbTitle" />
    }

    <IntroSection Model="@introSection" OnImageClick="@ShowImage" />

    @if (introSection.ShowNavigationButtons && introSection.NavigationButtons.Any())
    {
        <NavigationButtons Buttons="@introSection.NavigationButtons" />
    }

    <div class="wrapper-div py-3">
        @if (featureSections.Count > 0)
        {
            <section class="container mt-4 my-5 py-5 bg-white rounded-3" style="max-width:1000px">
                <div style="max-width:800px; margin: 0 auto;">
                    <FeatureSections Sections="@featureSections" IsAdmin="@isAdmin" 
                                   PageKey="omsystemet" OnImageClick="@ShowImage" />
                </div>
            </section>
        }

        <FaqAccordion FaqSections="faqSections" />

        <MemberLogosSection Title="Våra medlemmar:" IsDarkBackground="true" />
    </div>

    <ImageModal ImageUrl="@activeImage" OnClose="@CloseModal" />
}

@code {
    private PageContentViewModel pageContent = new();
    private bool loading = true;
    private bool isAdmin = false;
    private string? activeImage;
    private IntroSectionViewModel introSection = new();
    private List<FeatureSectionViewModel> featureSections = new();
    private List<FaqSectionViewModel> faqSections = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        isAdmin = authState.User.IsInRole("Admin");
        loading = true;

        try
        {
            pageContent = await Cms.GetPageContentAsync("omsystemet") ?? new PageContentViewModel
            {
                PageKey = "omsystemet",
                Title = "Om systemet",
                HtmlContent = "",
                LastModified = DateTime.Now,
                Images = new List<PageImageViewModel>()
            };

            introSection = await Cms.GetIntroSectionAsync("omsystemet");
            featureSections = await Cms.GetFeatureSectionsAsync("omsystemet");
            faqSections = await Cms.GetFaqSectionsAsync("omsystemet");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fel vid inläsning av Om systemet-sidan: {Message}", ex.Message);

            introSection = new IntroSectionViewModel
            {
                Title = "Något gick fel",
                Content = "<p>Det uppstod ett fel vid hämtning av innehållet.</p>"
            };
            featureSections = new List<FeatureSectionViewModel>();
            faqSections = new List<FaqSectionViewModel>();
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowImage(string imageUrl)
    {
        activeImage = imageUrl;
    }

    private void CloseModal() => activeImage = null;
}